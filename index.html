<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AE/SE Relationship Assessment</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for the radar chart and chartjs-plugin-annotation -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.4.0/chartjs-plugin-annotation.min.js"></script>

    <!-- jsPDF and html2canvas for PDF download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* Custom font and HiBob-inspired color scheme */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        :root {
            --hibob-purple: #5C3BFF;
            --hibob-teal: #00C4B3;
            --hibob-pink: #E6007E;
            --hibob-dark: #1E2022;
            --hibob-light-gray: #F8F9FA;
            --hibob-gray: #6c757d;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--hibob-light-gray);
            color: var(--hibob-dark);
        }
        h1, h2, h3 {
             color: var(--hibob-dark);
        }
        .chart-container {
            position: relative;
            height: 100%;
            width: 100%;
            min-height: 400px;
        }
        /* Simple transition for sections */
        #analysisSection {
            transition: opacity 0.5s ease-in-out;
        }

        .hibob-btn {
            color: white;
            font-weight: bold;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            padding-left: 2rem;
            padding-right: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            transition: all 0.3s ease;
        }
        .hibob-btn:hover {
            transform: scale(1.05);
        }

        .btn-relationship { background-color: var(--hibob-pink); }
        .btn-reset { background-color: var(--hibob-gray); }
        .btn-download { background-color: var(--hibob-pink); }
    </style>
</head>
<body>

    <div class="container mx-auto px-4 py-8">
        
        <!-- Assessment Page -->
        <div id="assessmentPage">
            <!-- Header -->
            <header class="text-center mb-10 relative">
                <h1 id="assessmentTitle" class="text-4xl md:text-5xl font-extrabold tracking-tight">
                    AE/SE Relationship Assessment
                </h1>
                <p id="assessmentSubtitle" class="mt-4 max-w-2xl mx-auto text-lg text-gray-500">
                    For up to 5 AEs, rate your partnership on Trust and Skills, then click "Show Analysis".
                </p>
            </header>

            <!-- Relationship Setup Screen -->
            <div id="relationshipSetupContainer" class="max-w-2xl mx-auto bg-white p-8 rounded-2xl shadow-lg text-center">
                <h3 class="text-2xl font-bold mb-4">Setup Your Assessment</h3>
                <div class="mb-6">
                    <label for="aeCount" class="block text-lg font-medium text-gray-700 mb-2">How many AEs are you assessing?</label>
                    <select id="aeCount" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500 sm:text-sm">
                        <option>1</option>
                        <option>2</option>
                        <option>3</option>
                        <option>4</option>
                        <option>5</option>
                    </select>
                </div>
                <div id="aeNameInputs" class="space-y-4 mb-8">
                    <!-- AE Name input fields will be generated here -->
                </div>
                <button id="startRelationshipAssessmentBtn" class="hibob-btn btn-relationship">Start Assessment</button>
            </div>

            <!-- Skill Levels Questions -->
            <div id="skillLevelsContainer" class="hidden">
                <!-- Skill level cards will be inserted here by JavaScript -->
            </div>

            <!-- Action Buttons -->
            <div id="actionButtons" class="text-center my-10 hidden">
                <button id="submitBtn" class="hibob-btn btn-relationship">
                    Show Analysis
                </button>
                <button id="resetBtn" class="hibob-btn btn-reset ml-4">
                    Reset
                </button>
                <p id="feedbackMsg" class="text-red-500 mt-4 hidden">Please rate all skills to see your analysis.</p>
            </div>
            
            <!-- Analysis Section (Initially Hidden) -->
            <div id="analysisSection" class="hidden opacity-0 transform translate-y-4">
                <div id="pdfContent">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
                        <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 border border-gray-200/80 flex flex-col">
                            <h2 id="chartTitle" class="text-2xl font-bold text-center mb-2">AE Relationship Matrix</h2>
                            <div class="chart-container flex-grow">
                                <canvas id="skillRadarChart"></canvas>
                            </div>
                        </div>
                        <div id="analysisTextContainer" class="bg-white rounded-2xl shadow-xl p-6 border border-gray-200/80">
                            <h2 class="text-2xl font-bold text-center mb-6">Partnership Analysis</h2>
                            <div id="relationshipAnalysisText" class="space-y-4">
                                <!-- Analysis text will be generated here -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-8 text-center">
                    <button id="downloadBtn" class="hibob-btn btn-download">Download Results as PDF</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const assessmentData = {
                title: "AE/SE Relationship Assessment",
                subtitle: 'For up to 5 AEs, rate your partnership on Trust and Skills, then click "Show Analysis".',
                type: 'scatter',
                themeColor: "#E6007E", // Pink
                quadrantLabels: {
                    synergy: { name: 'Synergy (DUO)', advice: "You're in a great spot! <strong>Next Step:</strong> Schedule a quarterly sync to review your partnership, celebrate wins, and identify one new strategic initiative you can tackle together to push the boundaries." },
                    energy: { name: 'Energy (Pair)', advice: "You have a foundation of trust. <strong>Next Step:</strong> To build skills alignment, schedule a 30-minute planning session for a key account and ask: 1) 'What is the single most important thing we want to achieve with this customer?' and 2) 'How can we best combine our skills to make that happen?'" },
                    apathy: { name: 'Apathy (Colleagues)', advice: "The foundation needs to be built. <strong>Next Step:</strong> Find a low-pressure moment (like a virtual coffee) to ask: 1) 'To help me be a better partner, could you share a bit about your work style and what you value most in an SE?' and 2) 'Here are my main goals for this quarter; what are yours?'" },
                    anarchy: { name: 'Anarchy (Competitors)', advice: "This is a tough spot that requires an open conversation. <strong>Next Step:</strong> Propose a meeting to establish 'Rules of Engagement'. Start by saying, 'I want to improve our partnership. Can we agree on clear lanes for deal strategy, technical validation, and customer communication to build more trust?' A manager's help might be needed." }
                },
                questions: [
                    { axis: 'trust', title: "Mutual Trust", question: "We mutually believe in each other's honesty, reliability, and competence." },
                    { axis: 'trust', title: "Reliable Backup", question: "I trust my AE to represent our solution accurately, and they trust me to handle technical aspects flawlessly." },
                    { axis: 'trust', title: "Open Communication", question: "We can have open, honest conversations about deal strategy, even when we disagree." },
                    { axis: 'skills', title: "Aligned Objective", question: "We have a clear and shared understanding of the common objective we need to achieve on our deals." },
                    { axis: 'skills', title: "Effective Collaboration", question: "We effectively apply our individual skills and knowledge to serve our common goal." },
                    { axis: 'skills', title: "Strategic Planning", question: "We strategically plan our joint activities (demos, meetings, follow-ups) to maximize our impact." }
                ]
            };

            // --- State Management ---
            let scores = {};
            let skillChart;

            // --- DOM Elements ---
            const skillLevelsContainer = document.getElementById('skillLevelsContainer');
            const relationshipSetupContainer = document.getElementById('relationshipSetupContainer');
            const aeCountSelect = document.getElementById('aeCount');
            const aeNameInputsContainer = document.getElementById('aeNameInputs');
            const startRelationshipAssessmentBtn = document.getElementById('startRelationshipAssessmentBtn');
            const actionButtons = document.getElementById('actionButtons');
            const ctx = document.getElementById('skillRadarChart').getContext('2d');
            const analysisSection = document.getElementById('analysisSection');
            const analysisContainer = document.getElementById('relationshipAnalysisText');
            const submitBtn = document.getElementById('submitBtn');
            const resetBtn = document.getElementById('resetBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const feedbackMsg = document.getElementById('feedbackMsg');

            // --- Functions ---
            const initializeChart = () => {
                const config = {
                    type: 'scatter',
                    data: { datasets: [] },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                            x: { title: { display: true, text: 'Trust Score', font: { size: 14, weight: 'bold' } }, min: 0, max: 5 },
                            y: { title: { display: true, text: 'Skills & Alignment Score', font: { size: 14, weight: 'bold' } }, min: 0, max: 5 }
                        },
                        plugins: {
                            legend: { position: 'top' },
                            annotation: { annotations: {
                                line1: { type: 'line', xMin: 2.5, xMax: 2.5, yMin: 0, yMax: 5, borderColor: 'rgba(0,0,0,0.2)', borderDash: [6, 6], borderWidth: 2 },
                                line2: { type: 'line', yMin: 2.5, yMax: 2.5, xMin: 0, xMax: 5, borderColor: 'rgba(0,0,0,0.2)', borderDash: [6, 6], borderWidth: 2 },
                                synergy: { type: 'label', xValue: 3.75, yValue: 3.75, content: 'Synergy', font: {size: 16, weight: 'bold'}, color: 'rgba(40, 167, 69, 0.5)' },
                                energy: { type: 'label', xValue: 1.25, yValue: 3.75, content: 'Energy', font: {size: 16, weight: 'bold'}, color: 'rgba(255, 193, 7, 0.5)' },
                                apathy: { type: 'label', xValue: 1.25, yValue: 1.25, content: 'Apathy', font: {size: 16, weight: 'bold'}, color: 'rgba(108, 117, 125, 0.5)' },
                                anarchy: { type: 'label', xValue: 3.75, yValue: 1.25, content: 'Anarchy', font: {size: 16, weight: 'bold'}, color: 'rgba(220, 53, 69, 0.5)' }
                            }}
                        }
                    }
                };
                if (ctx) { 
                    // No need for Chart.register with modern Chart.js and this plugin version
                    skillChart = new Chart(ctx, config); 
                }
            };
            
            const generateAENameInputs = (count) => {
                let html = '';
                for (let i = 1; i <= count; i++) {
                    html += `<input type="text" class="ae-name-setup-input block w-full p-2 border border-gray-300 rounded-md shadow-sm mb-2" placeholder="AE #${i} Name">`;
                }
                aeNameInputsContainer.innerHTML = html;
            };

            const startAssessment = () => {
                const nameInputs = document.querySelectorAll('.ae-name-setup-input');
                const aeNames = Array.from(nameInputs).map((input, i) => input.value.trim() || `AE #${i + 1}`);

                relationshipSetupContainer.classList.add('hidden');
                skillLevelsContainer.classList.remove('hidden');
                actionButtons.classList.remove('hidden');
                skillLevelsContainer.className = 'space-y-8';

                renderAECards(aeNames);
            };

            const renderAECards = (aeNames) => {
                let html = '';
                aeNames.forEach((name, i) => {
                    const aeIndex = i + 1;
                    scores[aeIndex] = { name: name, ratings: Array(assessmentData.questions.length).fill(0) };
                    html += createAECardHTML(aeIndex);
                });
                skillLevelsContainer.innerHTML = html;
            };

            const createAECardHTML = (aeIndex) => {
                const aeName = scores[aeIndex].name;
                const themeColor = assessmentData.themeColor;
                
                let questionsHTML = assessmentData.questions.map((q, qIndex) => {
                    const score = scores[aeIndex].ratings[qIndex] || 0;
                    let starsHTML = '';
                    for (let i = 1; i <= 5; i++) {
                        starsHTML += `<button data-ae-index="${aeIndex}" data-q-index="${qIndex}" data-rate="${i}" class="star-btn transition-transform duration-200 ease-in-out transform hover:scale-125 focus:outline-none focus:ring-2 focus:ring-offset-2 rounded-full p-1" style="--ring-color: ${themeColor}" aria-label="Rate ${i} out of 5"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${score >= i ? 'text-yellow-400 fill-current' : 'text-gray-300'}"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg></button>`;
                    }
                    return `<div class="py-3 sm:flex sm:items-center sm:justify-between"><p class="text-sm text-gray-700 sm:w-2/5">${q.title}: <span class="italic text-gray-500">"${q.question}"</span></p><div class="flex justify-center items-center space-x-1 mt-2 sm:mt-0">${starsHTML}</div></div>`;
                }).join('<hr>');

                return `<div class="bg-white p-6 rounded-xl shadow-md border border-gray-200/50" data-ae-card-index="${aeIndex}"><h3 class="text-xl font-bold p-2 rounded-lg w-full mb-4 text-center" style="color: ${themeColor}">${aeName}</h3><div class="space-y-2">${questionsHTML}</div></div>`;
            };
            
            const handleScoreChange = (qIndex, newScore, aeIndex) => {
                if (!scores[aeIndex]) scores[aeIndex] = { name: `AE #${aeIndex}`, ratings: Array(assessmentData.questions.length).fill(0) };
                scores[aeIndex].ratings[qIndex] = scores[aeIndex].ratings[qIndex] === newScore ? 0 : newScore;
                updateStarsUI(qIndex, aeIndex);
                updateChartData();
            };

            const updateStarsUI = (qIndex, aeIndex) => {
                const container = document.querySelector(`[data-ae-card-index="${aeIndex}"]`);
                if (!container) return;
                
                const score = scores[aeIndex]?.ratings[qIndex] || 0;
                const starButtons = container.querySelectorAll(`.star-btn[data-q-index="${qIndex}"]`);
                
                starButtons.forEach(button => {
                    const rate = parseInt(button.dataset.rate, 10);
                    const starIcon = button.querySelector('svg');
                    starIcon.classList.toggle('text-yellow-400', score >= rate);
                    starIcon.classList.toggle('fill-current', score >= rate);
                    starIcon.classList.toggle('text-gray-300', score < rate);
                });
            };

            const updateChartData = () => {
                if (!skillChart) return;
                const pointColors = ['#5C3BFF', '#00C4B3', '#E6007E', '#FFC107', '#6F42C1'];
                skillChart.data.datasets = Object.keys(scores).filter(aeIndex => scores[aeIndex]?.ratings.some(r => r > 0)).map((aeIndex, i) => {
                    const aeData = scores[aeIndex];
                    const trustScores = aeData.ratings.map((r, idx) => assessmentData.questions[idx].axis === 'trust' ? r : null).filter(r => r !== null);
                    const skillScores = aeData.ratings.map((r, idx) => assessmentData.questions[idx].axis === 'skills' ? r : null).filter(r => r !== null);
                    const avgTrust = trustScores.length ? trustScores.reduce((a, b) => a + b, 0) / trustScores.length : 0;
                    const avgSkills = skillScores.length ? skillScores.reduce((a, b) => a + b, 0) / skillScores.length : 0;
                    return { label: aeData.name, data: [{ x: avgTrust, y: avgSkills }], backgroundColor: pointColors[i % pointColors.length], pointRadius: 8, pointHoverRadius: 12 };
                });
                skillChart.update();
            };

            const handleSubmit = () => {
                const allRated = Object.values(scores).length > 0 && Object.values(scores).every(aeData => aeData.ratings.every(r => r > 0));
                if (allRated) {
                    feedbackMsg.classList.add('hidden');
                    showAnalysis();
                } else {
                    feedbackMsg.textContent = 'Please complete all ratings for all AEs to see the analysis.';
                    feedbackMsg.classList.remove('hidden');
                    hideAnalysis();
                }
            };
            
            const showAnalysis = () => {
                let analysisHTML = '';
                const quadrantLabels = assessmentData.quadrantLabels;
                const datasets = skillChart.data.datasets;
                
                if (datasets.length === 0) {
                    analysisHTML = `<p class="text-center text-gray-600">No data to analyze. Please complete the ratings for at least one AE.</p>`;
                } else {
                    datasets.forEach(dataset => {
                        const trust = dataset.data[0].x;
                        const skills = dataset.data[0].y;
                        let quadrant;
                        if (trust > 2.5 && skills > 2.5) quadrant = quadrantLabels.synergy;
                        else if (trust > 2.5 && skills <= 2.5) quadrant = quadrantLabels.energy;
                        else if (trust <= 2.5 && skills <= 2.5) quadrant = quadrantLabels.apathy;
                        else quadrant = quadrantLabels.anarchy;

                        analysisHTML += `<div class="p-3 rounded-lg" style="background-color: ${dataset.backgroundColor}33;"><p class="font-bold" style="color: ${dataset.backgroundColor};">${dataset.label}: <span class="font-medium">${quadrant.name}</span></p><p class="mt-1 text-sm text-gray-700">${quadrant.advice}</p></div>`;
                    });
                }
                analysisContainer.innerHTML = analysisHTML;

                analysisSection.classList.remove('hidden');
                setTimeout(() => {
                    analysisSection.classList.remove('opacity-0', 'transform', 'translate-y-4');
                    analysisSection.scrollIntoView({ behavior: 'smooth' });
                }, 10);
            };

            const hideAnalysis = () => {
                analysisSection.classList.add('opacity-0', 'transform', 'translate-y-4');
                setTimeout(() => analysisSection.classList.add('hidden'), 500);
            };
            
            const handleReset = () => {
                scores = {};
                skillLevelsContainer.innerHTML = '';
                relationshipSetupContainer.classList.remove('hidden');
                skillLevelsContainer.classList.add('hidden');
                actionButtons.classList.add('hidden');
                
                updateChartData();
                hideAnalysis();
                feedbackMsg.classList.add('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const handleDownload = () => {
                const { jsPDF } = window.jspdf;
                const contentToPrint = document.getElementById('pdfContent');
                
                html2canvas(contentToPrint, { scale: 2, backgroundColor: '#ffffff' }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF({ orientation: 'landscape', unit: 'px', format: [canvas.width, canvas.height] });
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    const fileName = `${assessmentData.title.replace(/\s/g, '_')}_Results.pdf`;
                    pdf.save(fileName);
                });
            };

            // --- Event Listeners ---
            aeCountSelect.addEventListener('change', (e) => generateAENameInputs(e.target.value));
            startRelationshipAssessmentBtn.addEventListener('click', startAssessment);
            skillLevelsContainer.addEventListener('click', (e) => {
                const starButton = e.target.closest('.star-btn');
                if (starButton) {
                    const aeIndex = starButton.dataset.aeIndex;
                    const qIndex = starButton.dataset.qIndex;
                    const rate = parseInt(starButton.dataset.rate, 10);
                    handleScoreChange(parseInt(qIndex, 10), rate, aeIndex);
                }
            });
            submitBtn.addEventListener('click', handleSubmit);
            resetBtn.addEventListener('click', handleReset);
            downloadBtn.addEventListener('click', handleDownload);

            // Initial setup
            generateAENameInputs(1);
            initializeChart();
        });
    </script>
</body>
</html>
