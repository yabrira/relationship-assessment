<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategic Partnership Assessment</title>
    <link rel="icon" type="image/png" href="https://www.google.com/url?sa=i&url=https%3A%2F%2Fwww.facebook.com%2FHiBobHR%2F&psig=AOvVaw3wt-IfuuNsXVb6cS86bjUl&ust=1752595208729000&source=images&cd=vfe&opi=89978449&ved=0CBQQjRxqFwoTCMjNsIjcvI4DFQAAAAAdAAAAABAE">
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js and annotation plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.4.0/chartjs-plugin-annotation.min.js"></script>
    <!-- jsPDF and html2canvas for PDF download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        :root {
            --hibob-purple: #5C3BFF; --hibob-teal: #00C4B3; --hibob-pink: #E6007E;
            --hibob-dark: #1E2022; --hibob-light-gray: #F8F9FA; --hibob-gray: #6c757d;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--hibob-light-gray); color: var(--hibob-dark); }
        h1, h2, h3 { color: var(--hibob-dark); }
        .chart-container { position: relative; height: 100%; width: 100%; min-height: 400px; }
        .hibob-btn {
            color: white; font-weight: bold; padding: 0.75rem 2rem; border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            transition: all 0.3s ease; display: inline-block;
        }
        .hibob-btn:hover { transform: scale(1.05); }
        .btn-relationship { background-color: var(--hibob-pink); }
        .btn-reset { background-color: var(--hibob-gray); }
        .btn-download { background-color: var(--hibob-pink); }
        
        /* Tab Styles */
        .tab-btn, .explainer-tab-btn {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 600;
            color: var(--hibob-gray);
        }
        .tab-btn.active, .explainer-tab-btn.active {
            color: var(--hibob-pink);
            border-bottom-color: var(--hibob-pink);
        }
        .tab-content, .explainer-tab-content {
            display: none;
        }
        .tab-content.active, .explainer-tab-content.active {
            display: block;
        }
        /* Stepper UI styles - update for custom pink */
        .stepper-step .active-step {
            background: rgb(230, 0, 126) !important;
            color: #fff !important;
        }
        .stepper-step .inactive-step {
            background: #e5e7eb !important;
            color: #6b7280 !important;
        }

        /* Star rating styles */
        .star-rating {
          display: flex;
          align-items: center;
          gap: 0.25rem;
        }
        .star {
          width: 28px;
          height: 28px;
          background: none;
          border: none;
          padding: 0;
          cursor: pointer;
          outline: none;
          color: #d1d5db;
          transition: color 0.2s;
          font-size: 1.5rem;
          line-height: 1;
        }
        .star.selected,
        .star.filled {
          color: rgb(230, 0, 126);
        }
        /* Add divider style for section separation */
        .section-divider {
          border-top: 2px solid #f1f1f1;
          margin: 2.5rem 0 2rem 0;
        }
        @media print {
          body.print-mode #assessmentPage > *:not(#step-results) { display: none !important; }
          body.print-mode #step-results { display: block !important; }
          body.print-mode .hibob-btn, body.print-mode select, body.print-mode input, body.print-mode .stepper-step, body.print-mode #results-back-btn, body.print-mode #results-download-btn, body.print-mode #print-friendly-btn, body.print-mode #example-pdf-btns-container-setup, body.print-mode #example-pdf-btn-container { display: none !important; }
          body.print-mode { background: white !important; }
          #step-results { box-shadow: none !important; border: none !important; }
          .print-page-break { page-break-before: always !important; break-before: page !important; }
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <div id="assessmentPage">
            <!-- Header -->
            <header class="text-center mb-10">
                <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight">Strategic Partnership Assessment</h1>
                <p class="mt-4 max-w-2xl mx-auto text-lg text-gray-500">A tool blending relationship diagnosis with polarity mapping for strategic growth.</p>
            </header>
            <!-- Stepper UI -->
            <div class="w-full max-w-3xl mx-auto mt-8 mb-6">
                <ol class="flex items-center w-full text-sm font-medium text-center text-gray-500">
                    <li class="flex-1 stepper-step" id="stepper-setup">
                        <span class="block p-2 rounded-full active-step mx-auto mb-1">1</span>
                        <span>Setup</span>
                    </li>
                    <li class="flex-1 stepper-step" id="stepper-assessment">
                        <span class="block p-2 rounded-full inactive-step mx-auto mb-1">2</span>
                        <span>Assessment</span>
                    </li>
                    <li class="flex-1 stepper-step" id="stepper-results">
                        <span class="block p-2 rounded-full inactive-step mx-auto mb-1">3</span>
                        <span>Results</span>
                    </li>
                </ol>
            </div>

            <!-- Step 1: Setup (existing UI) -->
            <div id="step-setup" class="step-section">
                <div id="relationshipSetupContainer" class="max-w-2xl mx-auto bg-white p-8 rounded-2xl shadow-lg text-center">
                    <h3 class="text-2xl font-bold mb-4">Setup Your Assessment</h3>
                    <div class="mb-6">
                        <label for="peerCount" class="block text-lg font-medium text-gray-700 mb-2">How many peers are you assessing?</label>
                        <select id="peerCount" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500 sm:text-sm">
                            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
                        </select>
                    </div>
                    <div id="peerNameInputs" class="space-y-4 mb-8"></div>
                    <button id="startRelationshipAssessmentBtn" class="hibob-btn btn-relationship">Start Assessment</button>
                </div>
            </div>

            <!-- Step 2: Assessment (Tabs per Person) -->
            <div id="step-assessment" class="step-section hidden">
                <div class="mb-6">
                    <div class="flex space-x-2 border-b border-gray-200">
                        <!-- Tabs for each person -->
                        <template id="person-tab-template">
                            <button class="tab-btn px-4 py-2 font-semibold text-gray-600 border-b-2 border-transparent focus:outline-none"></button>
                        </template>
                        <div id="person-tabs"></div>
                    </div>
                </div>
                <div id="person-assessment-cards">
                    <!-- Cards for each person, only one visible at a time -->
                </div>
                <div class="flex justify-between mt-8">
                    <button id="assessment-prev-btn" class="hibob-btn btn-reset">Previous</button>
                    <button id="assessment-next-btn" class="hibob-btn btn-relationship">Next</button>
                </div>
            </div>

            <!-- Step 3: Results -->
            <div id="step-results" class="step-section hidden">
                <div id="results-summary" class="mb-8">
                    <h2 class="text-2xl font-bold mb-2">Assessment Results</h2>
                    <p class="text-gray-600 text-sm mb-4">You assessed <span id="results-peer-count"></span> partnership(s) across relationship, work style, and interaction style dimensions.</p>
                </div>
                <div id="results-matrix-all" class="mb-8">
                    <h2 class="text-2xl font-bold mb-2">Relationship Matrix Overview</h2>
                    <div class="w-full flex justify-center mb-4">
                        <canvas id="matrixChart-all" style="max-width: 600px; width: 100%; height: 400px;"></canvas>
                    </div>
                    <div class="w-full">
                        <div class="bg-white rounded-xl shadow-md border border-gray-200/80 p-6 mx-auto" style="max-width: 700px;">
                            <h3 class="text-lg font-bold mb-4">Quadrant Meanings</h3>
                            <div class="space-y-4">
                                <div class="flex items-center gap-2"><span class="inline-block w-3 h-3 rounded-full" style="background:rgb(230,0,126)"></span><span class="font-semibold text-hibob-pink">Anarchy</span><span class="text-xs text-gray-500">â€” High skills/alignment, low trust. Great potential, but trust must be built for success.</span></div>
                                <div class="flex items-center gap-2"><span class="inline-block w-3 h-3 rounded-full" style="background:rgb(34,197,94)"></span><span class="font-semibold text-green-500">Synergy</span><span class="text-xs text-gray-500">â€” High trust and high skills/alignment. Ideal partnership for high performance.</span></div>
                                <div class="flex items-center gap-2"><span class="inline-block w-3 h-3 rounded-full" style="background:#bbb"></span><span class="font-semibold text-gray-400">Apathy</span><span class="text-xs text-gray-500">â€” Low trust and low skills/alignment. Partnership needs significant attention.</span></div>
                                <div class="flex items-center gap-2"><span class="inline-block w-3 h-3 rounded-full" style="background:#f59e42"></span><span class="font-semibold" style="color:#f59e42">Energy</span><span class="text-xs text-gray-500">â€” High trust, low skills/alignment. Good relationship, but need to align on goals and skills.</span></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="results-tabs" class="mb-4 flex flex-wrap gap-2"></div>
                <div id="results-people"></div>
                <div id="results-explainers">
                    <!-- Explainers and action items for each person -->
                </div>
                <div class="flex justify-end mt-8">
                    <button id="results-back-btn" class="hibob-btn btn-reset">Back</button>
                </div>
            </div>

            <!-- Action Buttons -->
            <div id="actionButtons" class="text-center my-10 hidden">
                <button id="submitBtn" class="hibob-btn btn-relationship">Show Analysis</button>
                <button id="resetBtn" class="hibob-btn btn-reset ml-4">Reset</button>
                <p id="feedbackMsg" class="text-red-500 mt-4 hidden">Please rate all skills to see your analysis.</p>
            </div>
            
            <!-- Analysis Section (Wraps everything for PDF) -->
            <div id="pdfContent">
                <!-- NEW: PDF Header -->
                <div id="pdfHeader" class="hidden">
                    <div class="text-center p-8 bg-white rounded-t-2xl border-b-4 border-pink-500">
                         <h1 class="text-4xl font-extrabold tracking-tight">Strategic Partnership Report</h1>
                         <p class="mt-2 text-gray-600">This report provides a comprehensive analysis of your peer/colleague partnerships, blending quantitative assessment with strategic polarity mapping to identify actionable growth opportunities.</p>
                    </div>
                </div>

                <!-- NEW: Top-level Polarity Explainer -->
                <div id="polarityExplainerSection" class="hidden"></div>

                <!-- Individual ratings cards will be moved here for the report -->
                <div id="skillLevelsReportContainer"></div>

                <!-- Initial Chart & Summary -->
                <div id="analysisSection" class="hidden opacity-0 transform translate-y-4">
                     <div class="text-center my-8 pt-8">
                        <h2 class="text-3xl font-extrabold tracking-tight">Partnership Analysis Summary</h2>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
                        <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-200/80 flex flex-col">
                            <h2 class="text-2xl font-bold text-center mb-2">Relationship Matrix</h2>
                            <div class="chart-container flex-grow"><canvas id="skillRadarChart"></canvas></div>
                        </div>
                        <div id="analysisTextContainer" class="bg-white rounded-2xl shadow-xl p-6 border border-gray-200/80">
                            <h2 class="text-2xl font-bold text-center mb-6">Partnership Diagnosis & Strategy</h2>
                            <div id="relationshipAnalysisText" class="space-y-6"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Download button outside the PDF content -->
            <div id="downloadButtonContainer" class="mt-8 text-center hidden">
                <button id="downloadBtn" class="hibob-btn btn-download">Download Results as PDF</button>
            </div>
        </div>
    </div>

<script>
// --- State ---
let currentStep = 1;
let people = [];
let assessmentData = {};
let currentPersonIdx = 0;

// --- Render Peer Name Inputs ---
function renderPeerNameInputs() {
  const count = parseInt(document.getElementById('peerCount').value, 10);
  const container = document.getElementById('peerNameInputs');
  container.innerHTML = '';
  for (let i = 0; i < count; i++) {
    const div = document.createElement('div');
    div.innerHTML = `
      <input
        type="text"
        class="peer-name-setup-input w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-pink-500 focus:border-pink-500"
        placeholder="Enter name for peer #${i + 1}"
      />
    `;
    container.appendChild(div);
  }
}

// --- Step Navigation ---
function showStep(step) {
  document.querySelectorAll('.step-section').forEach((el, i) => {
    el.classList.toggle('hidden', i !== step - 1);
  });
  // Update stepper UI
  const steps = [
    document.getElementById('stepper-setup'),
    document.getElementById('stepper-assessment'),
    document.getElementById('stepper-results')
  ];
  steps.forEach((stepEl, idx) => {
    const span = stepEl.querySelector('span');
    if (step === idx + 1) {
      span.className = 'block p-2 rounded-full active-step mx-auto mb-1';
    } else {
      span.className = 'block p-2 rounded-full inactive-step mx-auto mb-1';
    }
  });
  currentStep = step;
}

// --- Render Person Tabs and Cards ---
function renderPersonTabsAndCards() {
  const tabsContainer = document.getElementById('person-tabs');
  const cardsContainer = document.getElementById('person-assessment-cards');
  tabsContainer.innerHTML = '';
  cardsContainer.innerHTML = '';
  people.forEach((name, idx) => {
    // Tab
    const tab = document.createElement('button');
    tab.className = 'tab-btn px-4 py-2 font-semibold text-gray-600 border-b-2 border-transparent focus:outline-none' + (idx === currentPersonIdx ? ' active border-hibob-pink text-hibob-pink' : '');
    tab.textContent = name;
    tab.onclick = () => {
      currentPersonIdx = idx;
      renderPersonTabsAndCards();
    };
    tabsContainer.appendChild(tab);
    // Card
    const card = document.createElement('div');
    card.className = 'bg-white p-6 rounded-xl shadow-md border border-gray-200/50' + (idx === currentPersonIdx ? '' : ' hidden');
    card.innerHTML = `
      <!-- Relationship Matrix -->
      <div class="mb-8">
        <h4 class="font-semibold mb-4 text-lg">Relationship Matrix</h4>
        <div class="space-y-4">
          ${renderRelationshipRow('Mutual Trust', 'We mutually believe in each other\'s honesty, reliability, and competence.', 'trust', idx)}
          ${renderRelationshipRow('Reliable Backup', 'I trust ' + name + ' to represent our solution accurately, and they trust me to handle technical aspects flawlessly.', 'reliable_backup', idx)}
          ${renderRelationshipRow('Open Communication', 'We can have open, honest conversations about deal strategy, even when we disagree.', 'communication', idx)}
          ${renderRelationshipRow('Shared Goals', 'We have a clear and shared understanding of the common objective we need to achieve on our deals.', 'goals', idx)}
          ${renderRelationshipRow('Collaboration', 'We effectively apply our individual skills and knowledge to serve our common goal.', 'collaboration', idx)}
          ${renderRelationshipRow('Strategic Planning', 'We strategically plan our joint activities (demos, meetings, follow-ups) to maximize our impact.', 'strategic_planning', idx)}
        </div>
      </div>
      <div class="section-divider"></div>
      <!-- Work Style Preferences -->
      <div class="mb-8">
        <h4 class="font-semibold mb-4 text-lg">Work Style Preferences</h4>
        <p class="text-sm text-gray-600 mb-4">Understanding how ${name} approaches work and decision-making helps identify potential synergies and challenges in your partnership.</p>
        <div class="space-y-6">
          <div class="border border-gray-200 rounded-lg p-4">
            <label class="block text-sm font-medium mb-3">How does ${name} typically make decisions?</label>
            <div class="flex space-x-4">
              <label class="flex-1 border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50">
                <input type="radio" name="decision-${idx}" value="analytical" class="polarity-radio mr-2" data-person="${idx}" data-category="decision">
                <div>
                  <span class="text-xs text-gray-600">Gathers data, analyzes options systematically, makes evidence-based decisions.</span><br>
                  <span class="text-xs italic text-gray-400">Example: "Before making a recommendation, reviews all available sales metrics and customer feedback."</span>
                </div>
              </label>
              <label class="flex-1 border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50">
                <input type="radio" name="decision-${idx}" value="intuitive" class="polarity-radio mr-2" data-person="${idx}" data-category="decision">
                <div>
                  <span class="text-xs text-gray-600">Relies on gut instinct, experience, makes quick decisions based on feel.</span><br>
                  <span class="text-xs italic text-gray-400">Example: "Quickly decides to pursue a lead based on a strong hunch from past deals."</span>
                </div>
              </label>
            </div>
          </div>
          
          <div class="border border-gray-200 rounded-lg p-4">
            <label class="block text-sm font-medium mb-3">How does ${name} prefer to communicate?</label>
            <div class="flex space-x-4">
              <label class="flex-1 border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50">
                <input type="radio" name="comm-${idx}" value="direct" class="polarity-radio mr-2" data-person="${idx}" data-category="communication">
                <div>
                  <span class="text-xs text-gray-600">Straightforward, to-the-point, prefers clear and concise communication.</span><br>
                  <span class="text-xs italic text-gray-400">Example: "Sends brief, direct emails outlining next steps."</span>
                </div>
              </label>
              <label class="flex-1 border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50">
                <input type="radio" name="comm-${idx}" value="diplomatic" class="polarity-radio mr-2" data-person="${idx}" data-category="communication">
                <div>
                  <span class="text-xs text-gray-600">Considerate of feelings, builds relationships, uses tactful communication.</span><br>
                  <span class="text-xs italic text-gray-400">Example: "Carefully words feedback to maintain a positive team atmosphere."</span>
                </div>
              </label>
            </div>
          </div>
          
          <div class="border border-gray-200 rounded-lg p-4">
            <label class="block text-sm font-medium mb-3">What is ${name}'s typical work pace?</label>
            <div class="flex space-x-4">
              <label class="flex-1 border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50">
                <input type="radio" name="pace-${idx}" value="fast" class="polarity-radio mr-2" data-person="${idx}" data-category="pace">
                <div>
                  <span class="text-xs text-gray-600">Moves quickly, prefers rapid execution, gets results fast.</span><br>
                  <span class="text-xs italic text-gray-400">Example: "Completes follow-up tasks immediately after meetings."</span>
                </div>
              </label>
              <label class="flex-1 border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50">
                <input type="radio" name="pace-${idx}" value="deliberate" class="polarity-radio mr-2" data-person="${idx}" data-category="pace">
                <div>
                  <span class="text-xs text-gray-600">Takes time to be thorough, methodical, ensures quality.</span><br>
                  <span class="text-xs italic text-gray-400">Example: "Double-checks all details before sending proposals to clients."</span>
                </div>
              </label>
            </div>
          </div>
          
          <div class="border border-gray-200 rounded-lg p-4">
            <label class="block text-sm font-medium mb-3">How does ${name} approach risk and change?</label>
            <div class="flex space-x-4">
              <label class="flex-1 border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50">
                <input type="radio" name="risk-${idx}" value="high" class="polarity-radio mr-2" data-person="${idx}" data-category="risk">
                <div>
                  <span class="text-xs text-gray-600">Embraces innovation, experiments with new approaches, comfortable with uncertainty.</span><br>
                  <span class="text-xs italic text-gray-400">Example: "Volunteers to pilot a new sales strategy with an important client."</span>
                </div>
              </label>
              <label class="flex-1 border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50">
                <input type="radio" name="risk-${idx}" value="low" class="polarity-radio mr-2" data-person="${idx}" data-category="risk">
                <div>
                  <span class="text-xs text-gray-600">Prefers proven methods, established processes, conservative approaches.</span><br>
                  <span class="text-xs italic text-gray-400">Example: "Sticks to tried-and-true demo scripts for every presentation."</span>
                </div>
              </label>
            </div>
          </div>
        </div>
      </div>
      <div class="section-divider"></div>
      <!-- Interaction Style Questions -->
      <div class="mb-8">
        <h4 class="font-semibold mb-4 text-lg">Interaction Style</h4>
        <p class="text-sm text-gray-600 mb-4">Answer these questions about how ${name} typically behaves in work situations.</p>
        <div class="space-y-6">
          <div class="border border-gray-200 rounded-lg p-4">
            <label class="block text-sm font-medium mb-3">When working on projects, ${name} typically:</label>
            <div class="space-y-2">
              <label class="flex-1 border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50 flex items-center mb-2">
                <input type="radio" name="interaction-1-${idx}" value="analytical" class="interaction-radio mr-2" data-person="${idx}" data-question="1">
                <span class="text-xs text-gray-600">Focuses on gathering detailed information and analyzing all options before proceeding</span>
              </label>
              <label class="flex-1 border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50 flex items-center mb-2">
                <input type="radio" name="interaction-1-${idx}" value="driving" class="interaction-radio mr-2" data-person="${idx}" data-question="1">
                <span class="text-xs text-gray-600">Moves quickly to action and focuses on getting results efficiently</span>
              </label>
              <label class="flex-1 border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50 flex items-center mb-2">
                <input type="radio" name="interaction-1-${idx}" value="amiable" class="interaction-radio mr-2" data-person="${idx}" data-question="1">
                <span class="text-xs text-gray-600">Ensures everyone is comfortable and builds consensus before moving forward</span>
              </label>
              <label class="flex-1 border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50 flex items-center mb-2">
                <input type="radio" name="interaction-1-${idx}" value="expressive" class="interaction-radio mr-2" data-person="${idx}" data-question="1">
                <span class="text-xs text-gray-600">Generates creative ideas and energizes the team with enthusiasm</span>
              </label>
            </div>
          </div>
          
          <div class="border border-gray-200 rounded-lg p-4">
            <label class="block text-sm font-medium mb-3">In meetings, ${name} usually:</label>
            <div class="space-y-2">
              <label class="flex-1 border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50 flex items-center mb-2">
                <input type="radio" name="interaction-2-${idx}" value="analytical" class="interaction-radio mr-2" data-person="${idx}" data-question="2">
                <span class="text-xs text-gray-600">Asks detailed questions and wants to see data to support decisions</span>
              </label>
              <label class="flex-1 border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50 flex items-center mb-2">
                <input type="radio" name="interaction-2-${idx}" value="driving" class="interaction-radio mr-2" data-person="${idx}" data-question="2">
                <span class="text-xs text-gray-600">Pushes for quick decisions and focuses on action items and deadlines</span>
              </label>
              <label class="flex-1 border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50 flex items-center mb-2">
                <input type="radio" name="interaction-2-${idx}" value="amiable" class="interaction-radio mr-2" data-person="${idx}" data-question="2">
                <span class="text-xs text-gray-600">Listens to everyone's input and helps resolve conflicts diplomatically</span>
              </label>
              <label class="flex-1 border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50 flex items-center mb-2">
                <input type="radio" name="interaction-2-${idx}" value="expressive" class="interaction-radio mr-2" data-person="${idx}" data-question="2">
                <span class="text-xs text-gray-600">Shares ideas enthusiastically and helps create an engaging atmosphere</span>
              </label>
            </div>
          </div>
          
          <div class="border border-gray-200 rounded-lg p-4">
            <label class="block text-sm font-medium mb-3">When facing challenges, ${name} tends to:</label>
            <div class="space-y-2">
              <label class="flex-1 border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50 flex items-center mb-2">
                <input type="radio" name="interaction-3-${idx}" value="analytical" class="interaction-radio mr-2" data-person="${idx}" data-question="3">
                <span class="text-xs text-gray-600">Research the problem thoroughly and develop a systematic solution</span>
              </label>
              <label class="flex-1 border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50 flex items-center mb-2">
                <input type="radio" name="interaction-3-${idx}" value="driving" class="interaction-radio mr-2" data-person="${idx}" data-question="3">
                <span class="text-xs text-gray-600">Take immediate action and push through obstacles to get results</span>
              </label>
              <label class="flex-1 border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50 flex items-center mb-2">
                <input type="radio" name="interaction-3-${idx}" value="amiable" class="interaction-radio mr-2" data-person="${idx}" data-question="3">
                <span class="text-xs text-gray-600">Seek input from others and work collaboratively to find a solution</span>
              </label>
              <label class="flex-1 border border-gray-200 rounded-lg p-3 cursor-pointer hover:bg-gray-50 flex items-center mb-2">
                <input type="radio" name="interaction-3-${idx}" value="expressive" class="interaction-radio mr-2" data-person="${idx}" data-question="3">
                <span class="text-xs text-gray-600">Generate creative alternatives and motivate others to tackle the challenge</span>
              </label>
            </div>
          </div>
        </div>
      </div>
    `;
    cardsContainer.appendChild(card);
  });
  // Add event listeners for star ratings
  document.querySelectorAll('.star-rating').forEach(starRow => {
    const person = starRow.dataset.person;
    const category = starRow.dataset.category;
    const stars = starRow.querySelectorAll('.star');
    stars.forEach((star, i) => {
      star.addEventListener('click', function() {
        // Set rating
        if (!assessmentData[person]) assessmentData[person] = {};
        if (!assessmentData[person].relationship) assessmentData[person].relationship = {};
        assessmentData[person].relationship[category] = i + 1;
        // Update UI
        stars.forEach((s, idx) => {
          if (idx <= i) {
            s.classList.add('selected');
          } else {
            s.classList.remove('selected');
          }
        });
      });
      // Fill stars if already rated
      if (
        assessmentData[person] &&
        assessmentData[person].relationship &&
        assessmentData[person].relationship[category] >= i + 1
      ) {
        star.classList.add('selected');
      } else {
        star.classList.remove('selected');
      }
    });
  });
  
  // Add event listeners for polarity radios
  document.querySelectorAll('.polarity-radio').forEach(radio => {
    radio.addEventListener('change', function() {
      const person = this.dataset.person;
      const category = this.dataset.category;
      const value = this.value;
      
      if (!assessmentData[person]) assessmentData[person] = {};
      if (!assessmentData[person].polarity) assessmentData[person].polarity = {};
      assessmentData[person].polarity[category] = value;
    });
  });
  
  // Add event listeners for interaction style radios
  document.querySelectorAll('.interaction-radio').forEach(radio => {
    radio.addEventListener('change', function() {
      const person = this.dataset.person;
      const question = this.dataset.question;
      const value = this.value;
      
      if (!assessmentData[person]) assessmentData[person] = {};
      if (!assessmentData[person].interaction) assessmentData[person].interaction = {};
      assessmentData[person].interaction[question] = value;
      
      // Determine the most common interaction style from the answers
      const answers = assessmentData[person].interaction;
      const styleCounts = { analytical: 0, driving: 0, amiable: 0, expressive: 0 };
      
      Object.values(answers).forEach(style => {
        styleCounts[style]++;
      });
      
      // Find the most common style
      const dominantStyle = Object.keys(styleCounts).reduce((a, b) => 
        styleCounts[a] > styleCounts[b] ? a : b
      );
      
      assessmentData[person].socialStyle = dominantStyle;
    });
  });
  updateAssessmentNextButtonState();
}

// Helper to render a relationship row with stars
function renderRelationshipRow(label, desc, category, idx) {
  return `
    <div class="flex items-center justify-between py-2">
      <div class="text-sm font-medium text-gray-700" style="min-width:220px;">
        ${label}: <span class="italic text-gray-500 font-normal">"${desc}"</span>
      </div>
      <div class="star-rating" data-person="${idx}" data-category="${category}">
        <button type="button" class="star" aria-label="1 star">&#9734;</button>
        <button type="button" class="star" aria-label="2 stars">&#9734;</button>
        <button type="button" class="star" aria-label="3 stars">&#9734;</button>
        <button type="button" class="star" aria-label="4 stars">&#9734;</button>
        <button type="button" class="star" aria-label="5 stars">&#9734;</button>
      </div>
    </div>
  `;
}

// --- Next Button Logic ---
function updateAssessmentNextButtonState() {
  const nextBtn = document.getElementById('assessment-next-btn');
  const person = currentPersonIdx;
  // Check if all questions are answered for this person
  let allAnswered = true;
  // Relationship: 6 categories
  const rel = assessmentData[person]?.relationship || {};
  const relAnswered = ['trust','reliable_backup','communication','goals','collaboration','strategic_planning'].every(k => rel[k] && rel[k] > 0);
  // Polarity: 4
  const pol = assessmentData[person]?.polarity || {};
  const polAnswered = ['decision','communication','pace','risk'].every(k => pol[k]);
  // Interaction: 3
  const inter = assessmentData[person]?.interaction || {};
  const interAnswered = ['1','2','3'].every(k => inter[k]);
  allAnswered = relAnswered && polAnswered && interAnswered;
  nextBtn.disabled = !allAnswered;
  // Update button text
  if (currentPersonIdx < people.length - 1) {
    nextBtn.textContent = 'Next';
  } else {
    nextBtn.textContent = allAnswered ? 'See Results' : 'See Results';
  }
}

// --- Event Listeners ---
document.addEventListener('DOMContentLoaded', () => {
  // Step 1: Setup
  people = [];
  document.getElementById('startRelationshipAssessmentBtn').onclick = () => {
    // Collect names
    const nameInputs = document.querySelectorAll('.peer-name-setup-input');
    people = Array.from(nameInputs).map(input => input.value.trim() || 'Person');
    if (people.some(n => !n)) {
      alert('Please enter all names.');
      return;
    }
    currentPersonIdx = 0;
    renderPersonTabsAndCards();
    showStep(2);
  };
  // Render initial name inputs
  renderPeerNameInputs();
  // Update name inputs when peer count changes
  document.getElementById('peerCount').addEventListener('change', renderPeerNameInputs);
  // Step 2: Assessment navigation
  document.getElementById('assessment-prev-btn').onclick = () => {
    showStep(1);
  };
  document.getElementById('assessment-next-btn').onclick = () => {
    // Only proceed if enabled
    if (document.getElementById('assessment-next-btn').disabled) return;
    if (currentPersonIdx < people.length - 1) {
      currentPersonIdx++;
      renderPersonTabsAndCards();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    } else {
      showStep(3);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  };
  // Step 3: Results navigation
  document.getElementById('results-back-btn').onclick = () => {
    showStep(2);
  };
  // Re-check next button state on any input change
  document.addEventListener('change', function(e) {
    if (
      e.target.classList.contains('star') ||
      e.target.classList.contains('polarity-radio') ||
      e.target.classList.contains('interaction-radio')
    ) {
      updateAssessmentNextButtonState();
    }
  });
});

function renderResultsPage() {
  // Summary
  document.getElementById('results-peer-count').textContent = people.length;
  // 2x2 matrix for all peers
  const allMatrixCtx = document.getElementById('matrixChart-all')?.getContext('2d');
  const peerPoints = people.map((name, idx) => {
    const rel = (assessmentData[idx] || {}).relationship || {};
    return {
      name,
      trust: ((rel.trust || 0) + (rel.reliable_backup || 0) + (rel.communication || 0)) / 3,
      skills: ((rel.goals || 0) + (rel.collaboration || 0) + (rel.strategic_planning || 0)) / 3
    };
  });
  // Color palette for matrix points (legend)
  const matrixColors = [
    'rgb(230,0,126)', // hibob pink
    'rgb(34,197,94)', // green
    'rgb(59,130,246)', // blue
    'rgb(245,158,66)', // orange
    'rgb(168,85,247)' // purple
  ];
  // Pastel color palette for points
  const matrixPastels = [
    '#f9b4d2', // pastel pink
    '#b4f9c6', // pastel green
    '#b4d8f9', // pastel blue
    '#fae0b4', // pastel orange
    '#d6b4f9'  // pastel purple
  ];
  // --- FIX: Destroy previous chart instance if exists ---
  if (window.matrixChartInstance) {
    window.matrixChartInstance.destroy();
  }
  if (allMatrixCtx) {
    window.matrixChartInstance = new Chart(allMatrixCtx, {
      type: 'scatter',
      data: {
        datasets: peerPoints.map((p, i) => ({
          label: p.name,
          data: [{ x: p.trust, y: p.skills }],
          backgroundColor: matrixPastels[i % matrixPastels.length], // pastel for point
          borderColor: matrixColors[i % matrixColors.length], // strong color for legend
          pointRadius: 11,
          pointBorderWidth: 3
        }))
      },
      options: {
        responsive: false,
        plugins: {
          legend: { display: true, position: 'top' },
          annotation: {
            annotations: {
              vline: {
                type: 'line',
                xMin: 2.5,
                xMax: 2.5,
                borderColor: '#bbb',
                borderWidth: 2,
                borderDash: [6,6]
              },
              hline: {
                type: 'line',
                yMin: 2.5,
                yMax: 2.5,
                borderColor: '#bbb',
                borderWidth: 2,
                borderDash: [6,6]
              },
              anarchy: {
                type: 'label',
                xValue: 0.7,
                yValue: 4.3,
                backgroundColor: 'rgba(0,0,0,0)',
                color: 'rgb(230,0,126)',
                font: { size: 18, weight: 'bold' },
                content: ['Anarchy'],
                rotation: 0
              },
              synergy: {
                type: 'label',
                xValue: 4.1,
                yValue: 4.3,
                backgroundColor: 'rgba(0,0,0,0)',
                color: 'rgb(34,197,94)',
                font: { size: 18, weight: 'bold' },
                content: ['Synergy'],
                rotation: 0
              },
              apathy: {
                type: 'label',
                xValue: 0.7,
                yValue: 0.7,
                backgroundColor: 'rgba(0,0,0,0)',
                color: '#bbb',
                font: { size: 18, weight: 'bold' },
                content: ['Apathy'],
                rotation: 0
              },
              energy: {
                type: 'label',
                xValue: 4.1,
                yValue: 0.7,
                backgroundColor: 'rgba(0,0,0,0)',
                color: '#f59e42',
                font: { size: 18, weight: 'bold' },
                content: ['Energy'],
                rotation: 0
              }
            }
          }
        },
        scales: {
          x: {
            min: 0, max: 5,
            title: { display: true, text: 'Trust Score', font: { weight: 'bold', size: 15 } },
            grid: { color: '#eee' },
            ticks: { stepSize: 1, color: '#888', font: { size: 12 } }
          },
          y: {
            min: 0, max: 5,
            title: { display: true, text: 'Skills & Alignment Score', font: { weight: 'bold', size: 15 } },
            grid: { color: '#eee' },
            ticks: { stepSize: 1, color: '#888', font: { size: 12 } }
          }
        }
      }
    });
  }
  // Tabs for peer details
  const tabsContainer = document.getElementById('results-tabs');
  tabsContainer.innerHTML = '';
  people.forEach((name, idx) => {
    const tab = document.createElement('button');
    tab.className = 'px-4 py-2 rounded-lg font-semibold ' + (idx === 0 ? 'bg-pink-100 text-hibob-pink' : 'bg-gray-100 text-gray-600');
    tab.textContent = name;
    tab.onclick = () => renderPeerDetail(idx);
    tabsContainer.appendChild(tab);
  });
  // Render first peer by default
  renderPeerDetail(0);

  // Attach PDF download event listener after rendering button
  const pdfBtn = document.getElementById('results-download-btn');
  if (pdfBtn) {
    pdfBtn.onclick = async function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'a4' });
      const pageWidth = doc.internal.pageSize.getWidth();
      let y = 40;
      // Executive Summary Title
      doc.setFontSize(22);
      doc.setFont('helvetica', 'bold');
      doc.text('Strategic Partnership Assessment', pageWidth / 2, y, { align: 'center' });
      y += 30;
      doc.setFontSize(12);
      doc.setFont('helvetica', 'normal');
      doc.text(`Date: ${new Date().toLocaleDateString()}`, pageWidth - 60, 40, { align: 'right' });
      y += 10;
      // Executive Summary (expanded)
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text('Executive Summary', 60, y);
      y += 18;
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(12);
      const summaryText = `You assessed ${people.length} partnership(s) across relationship, work style, and interaction style dimensions. This report provides a comprehensive analysis of your peer/colleague partnerships, blending quantitative assessment with strategic polarity mapping to identify actionable growth opportunities. The matrix below shows the overall relationship landscape, with each peer plotted by trust and skills/alignment.`;
      const summaryLines = doc.splitTextToSize(summaryText, pageWidth - 120);
      doc.text(summaryLines, 60, y);
      y += summaryLines.length * 15 + 10;
      // Matrix chart as image
      const matrixCanvas = document.getElementById('matrixChart-all');
      const matrixImg = await html2canvas(matrixCanvas, { backgroundColor: null }).then(canvas => canvas.toDataURL('image/png'));
      doc.addImage(matrixImg, 'PNG', 60, y, pageWidth - 120, (pageWidth - 120) * 0.7);
      y += (pageWidth - 120) * 0.7 + 20;
      // Quadrant meanings
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text('Quadrant Meanings', 60, y);
      y += 18;
      doc.setFontSize(11);
      doc.setFont('helvetica', 'normal');
      const quadrantLines = [
        ['Anarchy', 'High skills/alignment, low trust. Great potential, but trust must be built for success.'],
        ['Synergy', 'High trust and high skills/alignment. Ideal partnership for high performance.'],
        ['Apathy', 'Low trust and low skills/alignment. Partnership needs significant attention.'],
        ['Energy', 'High trust, low skills/alignment. Good relationship, but need to align on goals and skills.']
      ];
      const quadrantColors = ['#e6007e', '#22c55e', '#bbb', '#f59e42'];
      quadrantLines.forEach(([label, desc], i) => {
        doc.setTextColor(quadrantColors[i]);
        doc.setFont('helvetica', 'bold');
        doc.text(label, 70, y);
        doc.setTextColor('#444');
        doc.setFont('helvetica', 'normal');
        doc.text(desc, 130, y);
        y += 18;
      });
      // Per-person pages
      people.forEach((name, idx) => {
        doc.addPage();
        let py = 60;
        doc.setFontSize(18);
        doc.setFont('helvetica', 'bold');
        doc.text(name, 60, py);
        py += 24;
        // Relationship Matrix
        doc.setFontSize(13);
        doc.setFont('helvetica', 'bold');
        doc.text('Relationship Matrix', 60, py);
        py += 18;
        doc.setFont('helvetica', 'normal');
        const rel = (assessmentData[idx] || {}).relationship || {};
        const relRows = [
          { label: 'Mutual Trust', key: 'trust', icon: 'ðŸ¤' },
          { label: 'Reliable Backup', key: 'reliable_backup', icon: 'ðŸ›¡ï¸' },
          { label: 'Open Communication', key: 'communication', icon: 'ðŸ’¬' },
          { label: 'Shared Goals', key: 'goals', icon: 'ðŸŽ¯' },
          { label: 'Collaboration', key: 'collaboration', icon: 'ðŸ¤²' },
          { label: 'Strategic Planning', key: 'strategic_planning', icon: 'ðŸ—ºï¸' }
        ];
        relRows.forEach(row => {
          doc.text(`${row.icon} ${row.label}: ${rel[row.key] || '-'}/5`, 80, py);
          py += 15;
        });
        py += 12;
        // Work Style
        doc.setFont('helvetica', 'bold');
        doc.text('Work Style Preferences', 60, py);
        py += 18;
        doc.setFont('helvetica', 'normal');
        const pol = (assessmentData[idx] || {}).polarity || {};
        const polRows = [
          { label: 'Decision Making', key: 'decision', map: { analytical: 'Analytical', intuitive: 'Intuitive' }, icon: 'ðŸ§ ', explain: {
            analytical: 'Analytical decision makers rely on data, logic, and careful analysis. They are thorough, objective, and minimize risk by considering all options. They may take longer to decide, but their choices are well-founded.',
            intuitive: 'Intuitive decision makers trust their instincts and experience. They are comfortable making quick judgments, even with incomplete information, and often spot patterns others miss. This can lead to creative solutions and rapid progress.'
          } },
          { label: 'Communication', key: 'communication', map: { direct: 'Direct', diplomatic: 'Diplomatic' }, icon: 'ðŸ—£ï¸', explain: {
            direct: 'Direct communicators are clear and to the point. They value efficiency and transparency, preferring straightforward conversations that get to the heart of the matter quickly. They appreciate when others are equally direct and may become frustrated with overly complex explanations or beating around the bush.',
            diplomatic: 'Diplomatic communicators are tactful and relationship-focused. They carefully consider how their words will be received and work to maintain harmony in conversations. They excel at navigating sensitive topics and building consensus, though they may sometimes avoid difficult truths to preserve relationships.'
          } },
          { label: 'Work Pace', key: 'pace', map: { fast: 'Fast', deliberate: 'Deliberate' }, icon: 'âš¡', explain: {
            fast: 'Fast workers move quickly and get results. They thrive on momentum and rapid iteration, often making quick decisions and adjustments as they go. They are highly responsive to changing circumstances and can adapt their approach mid-stream. While they may occasionally miss details, their speed often creates competitive advantages.',
            deliberate: 'Deliberate workers are thorough and methodical. They take time to consider all angles and ensure quality before moving forward. They prefer to have a clear plan and complete information before acting, which leads to well-thought-out solutions and fewer mistakes. They may move slower initially but often avoid costly rework.'
          } },
          { label: 'Risk Approach', key: 'risk', map: { high: 'Embraces Innovation', low: 'Prefers Proven Methods' }, icon: 'ðŸŽ²', explain: {
            high: 'Embraces innovation and is comfortable with uncertainty. They actively seek out new approaches and are willing to experiment with unproven methods. They see failure as a learning opportunity and are energized by the challenge of solving problems in novel ways. Their willingness to take calculated risks often leads to breakthrough solutions.',
            low: 'Prefers proven methods and established processes. They value stability and reliability, choosing approaches that have demonstrated success. They are cautious about change and prefer to improve existing systems rather than replace them. While they may miss some opportunities, their conservative approach often prevents costly mistakes.'
          } }
        ];
        polRows.forEach(row => {
          const val = pol[row.key];
          if (!val) return;
          doc.text(`${row.icon} ${row.label}: ${row.map[val]}`, 80, py);
          py += 13;
          doc.setFontSize(10);
          const explLines = doc.splitTextToSize(row.explain[val], pageWidth - 120);
          doc.text(explLines, 100, py);
          doc.setFontSize(13);
          py += explLines.length * 13 + 8;
        });
        // Interaction Style
        py += 4;
        doc.setFont('helvetica', 'bold');
        doc.text('Dominant Interaction Style', 60, py);
        py += 18;
        doc.setFont('helvetica', 'normal');
        const style = (assessmentData[idx] || {}).socialStyle || '';
        const styleMap = {
          analytical: 'Analytical: Methodical, detail-oriented, values accuracy. Prefers to gather all relevant information before making decisions.',
          driving: 'Driving: Decisive, results-focused, and thrives on achievement. Quick to make decisions and set ambitious goals.',
          amiable: 'Amiable: Supportive, cooperative, and values relationships. Works to create harmony and is sensitive to the needs of others.',
          expressive: 'Expressive: Enthusiastic, creative, and persuasive. Energizes teams with ideas and optimism.'
        };
        const styleLines = doc.splitTextToSize(styleMap[style] || '-', pageWidth - 120);
        doc.text(styleLines, 80, py);
        py += styleLines.length * 13 + 8;
        // Action Items
        doc.setFont('helvetica', 'bold');
        doc.text('Action Items', 60, py);
        py += 16;
        doc.setFont('helvetica', 'normal');
        const actions = [];
        if ((rel.trust || 0) < 3) actions.push('Schedule a 1:1 coffee chat or informal meeting to build mutual trust. Share a recent success and ask about theirs.');
        if ((rel.reliable_backup || 0) < 3) actions.push('Clarify roles and responsibilities in your next project. For example, write down who owns which deliverable and review together.');
        if ((rel.communication || 0) < 3) actions.push('Set up a recurring 15-minute sync to discuss deal strategy and encourage open feedback. Try using a shared doc for agenda and notes.');
        if ((rel.goals || 0) < 3) actions.push('At your next team meeting, align on a shared goal and write it down. Ask each person to describe what success looks like.');
        if ((rel.collaboration || 0) < 3) actions.push('Invite your peer to co-lead a client call or demo. Debrief afterwards to discuss what went well and what could improve.');
        if ((rel.strategic_planning || 0) < 3) actions.push('Plan your next joint activity together, such as a customer workshop. Outline the agenda collaboratively in advance.');
        if (actions.length === 0) actions.push('Keep up the great partnership! Consider celebrating your success with a team lunch or shoutout.');
        actions.forEach(a => {
          doc.setFontSize(11);
          const actionLines = doc.splitTextToSize(`- ${a}`, pageWidth - 120);
          doc.text(actionLines, 80, py);
          py += actionLines.length * 12 + 4;
        });
      });
      doc.save('partnership-assessment.pdf');
    };
  }
}
// Render details for a single peer
function renderPeerDetail(idx) {
  const peopleContainer = document.getElementById('results-people');
  peopleContainer.innerHTML = '';
  const name = people[idx];
  const data = assessmentData[idx] || {};
  const rel = data.relationship || {};
  const relRows = [
    { label: 'Mutual Trust', key: 'trust', icon: 'ðŸ¤' },
    { label: 'Reliable Backup', key: 'reliable_backup', icon: 'ðŸ›¡ï¸' },
    { label: 'Open Communication', key: 'communication', icon: 'ðŸ’¬' },
    { label: 'Shared Goals', key: 'goals', icon: 'ðŸŽ¯' },
    { label: 'Collaboration', key: 'collaboration', icon: 'ðŸ¤²' },
    { label: 'Strategic Planning', key: 'strategic_planning', icon: 'ðŸ—ºï¸' }
  ];
  const pol = data.polarity || {};
  const polRows = [
    { label: 'Decision Making', key: 'decision', map: { analytical: 'Analytical', intuitive: 'Intuitive' }, icon: 'ðŸ§ ',
      explain: {
        analytical: {
          desc: 'Analytical decision makers rely on data, logic, and careful analysis. They are thorough, objective, and minimize risk by considering all options. They may take longer to decide, but their choices are well-founded.',
          strengths: 'Thorough, objective, minimizes risk.',
          growth: 'May overanalyze or delay decisions.'
        },
        intuitive: {
          desc: 'Intuitive decision makers trust their instincts and experience. They are comfortable making quick judgments, even with incomplete information, and often spot patterns others miss. This can lead to creative solutions and rapid progress.',
          strengths: 'Fast, creative, adapts quickly.',
          growth: 'May overlook details or act impulsively.'
        }
      }
    },
    { label: 'Communication', key: 'communication', map: { direct: 'Direct', diplomatic: 'Diplomatic' }, icon: 'ðŸ—£ï¸',
      explain: {
        direct: {
          desc: 'Direct communicators are clear and to the point. They are efficient, avoids misunderstandings.',
          strengths: 'Efficient, avoids misunderstandings.',
          growth: 'Can be perceived as blunt.'
        },
        diplomatic: {
          desc: 'Diplomatic communicators are tactful and relationship-focused. They build rapport, resolves conflict.',
          strengths: 'Builds rapport, resolves conflict.',
          growth: 'May avoid tough conversations.'
        }
      }
    },
    { label: 'Work Pace', key: 'pace', map: { fast: 'Fast', deliberate: 'Deliberate' }, icon: 'âš¡',
      explain: {
        fast: {
          desc: 'Fast workers move quickly and get results. They are responsive, meets deadlines.',
          strengths: 'Responsive, meets deadlines.',
          growth: 'May miss details.'
        },
        deliberate: {
          desc: 'Deliberate workers are thorough and methodical. They are high quality, reliable.',
          strengths: 'High quality, reliable.',
          growth: 'May be slow to act.'
        }
      }
    },
    { label: 'Risk Approach', key: 'risk', map: { high: 'Embraces Innovation', low: 'Prefers Proven Methods' }, icon: 'ðŸŽ²',
      explain: {
        high: {
          desc: 'Embraces innovation and is comfortable with uncertainty. They drive change, finds new solutions.',
          strengths: 'Drives change, finds new solutions.',
          growth: 'May take unnecessary risks.'
        },
        low: {
          desc: 'Prefers proven methods and established processes. They are stable, minimizes mistakes.',
          strengths: 'Stable, minimizes mistakes.',
          growth: 'May resist change.'
        }
      }
    }
  ];
  const style = data.socialStyle || '';
  const styleMap = {
    analytical: {
      label: 'Analytical', icon: 'ðŸ“Š',
      desc: 'Analytical types are methodical, detail-oriented, and value accuracy. They prefer to gather all relevant information before making decisions and are often seen as logical and objective. In meetings, they may ask probing questions and seek data to support conclusions.',
      strengths: 'Detail-oriented, logical, thorough, objective.',
      growth: 'May seem distant or slow to decide. Can get stuck in analysis paralysis.',
      expanded: `<ul class='list-disc pl-5 text-xs text-gray-600 mt-1'>
        <li><b>Typical behaviors:</b> Asks for data, double-checks facts, prefers written communication.</li>
        <li><b>How others see them:</b> Reliable, but sometimes slow or overly critical.</li>
        <li><b>Collaboration tips:</b> Provide clear data, allow time for analysis, encourage sharing insights.</li>
        <li><b>Watch out for:</b> Overanalyzing, reluctance to make quick decisions.</li>
      </ul>`
    },
    driving: {
      label: 'Driving', icon: 'ðŸš€',
      desc: 'Driving personalities are decisive, results-focused, and thrive on achievement. They are quick to make decisions, set ambitious goals, and push teams forward. Their directness and confidence can inspire action.',
      strengths: 'Gets things done, confident, ambitious, decisive.',
      growth: 'May be impatient or overlook input from others.',
      expanded: `<ul class='list-disc pl-5 text-xs text-gray-600 mt-1'>
        <li><b>Typical behaviors:</b> Sets clear goals, moves quickly, expects high performance.</li>
        <li><b>How others see them:</b> Inspiring, but sometimes impatient or blunt.</li>
        <li><b>Collaboration tips:</b> Be concise, focus on outcomes, respect their need for efficiency.</li>
        <li><b>Watch out for:</b> Dismissing others' input, moving too fast for the team.</li>
      </ul>`
    },
    amiable: {
      label: 'Amiable', icon: 'ðŸ¤—',
      desc: 'Amiable types are supportive, cooperative, and value relationships. They work to create harmony and are sensitive to the needs of others. They excel at building consensus and resolving conflicts diplomatically.',
      strengths: 'Team player, empathetic, diplomatic, supportive.',
      growth: 'May avoid conflict or be indecisive.',
      expanded: `<ul class='list-disc pl-5 text-xs text-gray-600 mt-1'>
        <li><b>Typical behaviors:</b> Listens actively, seeks input, mediates disagreements.</li>
        <li><b>How others see them:</b> Trustworthy, but sometimes indecisive or conflict-averse.</li>
        <li><b>Collaboration tips:</b> Show appreciation, involve them in team decisions, provide reassurance.</li>
        <li><b>Watch out for:</b> Reluctance to address issues directly, difficulty making tough calls.</li>
      </ul>`
    },
    expressive: {
      label: 'Expressive', icon: 'ðŸŽ‰',
      desc: 'Expressive types are enthusiastic, creative, and persuasive. They energize teams with their ideas and optimism, and are skilled at motivating others and generating excitement for new initiatives.',
      strengths: 'Motivates others, generates ideas, persuasive, energetic.',
      growth: 'May be disorganized or impulsive.',
      expanded: `<ul class='list-disc pl-5 text-xs text-gray-600 mt-1'>
        <li><b>Typical behaviors:</b> Shares ideas freely, encourages brainstorming, celebrates wins.</li>
        <li><b>How others see them:</b> Inspiring, but sometimes scattered or unfocused.</li>
        <li><b>Collaboration tips:</b> Encourage creativity, provide structure, help prioritize tasks.</li>
        <li><b>Watch out for:</b> Losing focus, neglecting follow-through.</li>
      </ul>`
    }
  };
  // Action items based on scores
  const actions = [];
  if ((rel.trust || 0) < 3) actions.push('Schedule a 1:1 coffee chat or informal meeting to build mutual trust. Share a recent success and ask about theirs.');
  if ((rel.reliable_backup || 0) < 3) actions.push('Clarify roles and responsibilities in your next project. For example, write down who owns which deliverable and review together.');
  if ((rel.communication || 0) < 3) actions.push('Set up a recurring 15-minute sync to discuss deal strategy and encourage open feedback. Try using a shared doc for agenda and notes.');
  if ((rel.goals || 0) < 3) actions.push('At your next team meeting, align on a shared goal and write it down. Ask each person to describe what success looks like.');
  if ((rel.collaboration || 0) < 3) actions.push('Invite your peer to co-lead a client call or demo. Debrief afterwards to discuss what went well and what could improve.');
  if ((rel.strategic_planning || 0) < 3) actions.push('Plan your next joint activity together, such as a customer workshop. Outline the agenda collaboratively in advance.');
  if (actions.length === 0) actions.push('Keep up the great partnership! Consider celebrating your success with a team lunch or shoutout.');
  // Build HTML
  const card = document.createElement('div');
  card.className = 'bg-white rounded-xl shadow-md border border-gray-200/80 mb-8 p-6';
  card.innerHTML = `
    <div class="mb-6">
      <h4 class="font-semibold text-base text-gray-700 mb-2">Relationship Matrix</h4>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        ${relRows.map(row => {
          const score = rel[row.key] || 0;
          let badge = score >= 4 ? 'bg-green-100 text-green-700' : score >= 3 ? 'bg-yellow-100 text-yellow-700' : 'bg-pink-100 text-hibob-pink';
          return `<div class="flex items-center gap-3 p-3 rounded-lg border border-gray-100 bg-gray-50">
            <span class="text-xl">${row.icon}</span>
            <span class="flex-1 text-sm">${row.label}</span>
            <span class="px-2 py-1 rounded text-xs font-bold ${badge}">${score}/5</span>
          </div>`;
        }).join('')}
      </div>
    </div>
    <div class="mb-6">
      <h4 class="font-semibold text-base text-gray-700 mb-2">Work Style Preferences</h4>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        ${polRows.map(row => {
          const val = pol[row.key];
          if (!val) return '';
          const expl = row.explain[val];
          return `<div class="bg-gray-50 border border-gray-100 rounded-lg p-4 flex flex-col gap-1">
            <div class="flex items-center gap-2 mb-1"><span class="text-lg">${row.icon}</span><span class="font-semibold text-sm">${row.label}: ${row.map[val]}</span></div>
            <div class="text-xs text-gray-600 mb-1">${expl.desc}</div>
            ${expl.expanded || ''}
            <div class="flex gap-2 text-xs">
              <span class="bg-green-100 text-green-700 px-2 py-0.5 rounded">Strength: ${expl.strengths}</span>
              <span class="bg-pink-100 text-hibob-pink px-2 py-0.5 rounded">Growth: ${expl.growth}</span>
            </div>
          </div>`;
        }).join('')}
      </div>
    </div>
    <div class="mb-6">
      <h4 class="font-semibold text-base text-gray-700 mb-2">Dominant Interaction Style</h4>
      <div class="bg-gray-50 border border-gray-100 rounded-lg p-4 flex flex-col gap-1">
        <div class="flex items-center gap-2 mb-1">
          <span class="text-lg">${styleMap[style]?.icon || ''}</span>
          <span class="font-semibold text-sm">${styleMap[style]?.label || '-'}</span>
        </div>
        <div class="text-xs text-gray-600 mb-1">${styleMap[style]?.desc || ''}</div>
        ${styleMap[style]?.expanded || ''}
        <div class="flex gap-2 text-xs">
          <span class="bg-green-100 text-green-700 px-2 py-0.5 rounded">Strength: ${styleMap[style]?.strengths || ''}</span>
          <span class="bg-pink-100 text-hibob-pink px-2 py-0.5 rounded">Growth: ${styleMap[style]?.growth || ''}</span>
        </div>
      </div>
    </div>
    <div class="mb-2">
      <h4 class="font-semibold text-base text-gray-700 mb-2">Action Items</h4>
      <div class="bg-gray-50 border border-gray-100 rounded-lg p-4">
        <ul class="list-disc pl-6 text-xs text-gray-700">
          ${actions.map(a => `<li>${a}</li>`).join('')}
        </ul>
      </div>
    </div>
  `;
  peopleContainer.appendChild(card);
  // Highlight selected tab
  const tabsContainer = document.getElementById('results-tabs');
  Array.from(tabsContainer.children).forEach((tab, i) => {
    tab.className = 'px-4 py-2 rounded-lg font-semibold ' + (i === idx ? 'bg-pink-100 text-hibob-pink' : 'bg-gray-100 text-gray-600');
  });
}
// Call renderResultsPage when showing results step
const origShowStep = showStep;
showStep = function(step) {
  origShowStep(step);
  if (step === 3) renderResultsPage();
};

// DEV ONLY: Example PDF button logic (remove after testing)
document.addEventListener('DOMContentLoaded', () => {
  const exampleBtn = document.getElementById('download-example-pdf-btn-text');
  if (exampleBtn) {
    exampleBtn.onclick = function() {
      people = ['Alice Example', 'Bob Sample'];
      assessmentData = [
        {
          relationship: {
            trust: 5, reliable_backup: 4, communication: 5, goals: 4, collaboration: 5, strategic_planning: 4
          },
          polarity: {
            decision: 'analytical', communication: 'direct', pace: 'fast', risk: 'high'
          },
          socialStyle: 'driving'
        },
        {
          relationship: {
            trust: 2, reliable_backup: 2, communication: 3, goals: 2, collaboration: 3, strategic_planning: 2
          },
          polarity: {
            decision: 'intuitive', communication: 'diplomatic', pace: 'deliberate', risk: 'low'
          },
          socialStyle: 'amiable'
        }
      ];
      renderResultsPage();
      setTimeout(() => {
        document.getElementById('results-download-btn')?.click();
      }, 500);
    };
  }
});

// DEV ONLY: Example PDF button logic for setup page (remove after testing)
document.addEventListener('DOMContentLoaded', () => {
  const exampleBtnSetup = document.getElementById('download-example-pdf-btn-setup');
  if (exampleBtnSetup) {
    exampleBtnSetup.onclick = function() {
      people = ['Alice Example', 'Bob Sample'];
      assessmentData = [
        {
          relationship: {
            trust: 5, reliable_backup: 4, communication: 5, goals: 4, collaboration: 5, strategic_planning: 4
          },
          polarity: {
            decision: 'analytical', communication: 'direct', pace: 'fast', risk: 'high'
          },
          socialStyle: 'driving'
        },
        {
          relationship: {
            trust: 2, reliable_backup: 2, communication: 3, goals: 2, collaboration: 3, strategic_planning: 2
          },
          polarity: {
            decision: 'intuitive', communication: 'diplomatic', pace: 'deliberate', risk: 'low'
          },
          socialStyle: 'amiable'
        }
      ];
      showStep(3);
      setTimeout(() => {
        document.getElementById('results-download-btn')?.click();
      }, 500);
    };
  }
});

// --- PDF Generation with Text Icons ---
function generatePdfTextIcons() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'pt', format: 'a4' });
  const pageWidth = doc.internal.pageSize.getWidth();
  let y = 40;
  doc.setFontSize(22);
  doc.setFont('helvetica', 'bold');
  doc.text('Strategic Partnership Assessment', pageWidth / 2, y, { align: 'center' });
  y += 30;
  doc.setFontSize(12);
  doc.setFont('helvetica', 'normal');
  doc.text(`Date: ${new Date().toLocaleDateString()}`, pageWidth - 60, 40, { align: 'right' });
  y += 10;
  doc.setFontSize(14);
  doc.setFont('helvetica', 'bold');
  doc.text('Executive Summary', 60, y);
  y += 18;
  doc.setFont('helvetica', 'normal');
  doc.setFontSize(12);
  const summaryText = `You assessed ${people.length} partnership(s) across relationship, work style, and interaction style dimensions. This report provides a comprehensive analysis of your peer/colleague partnerships, blending quantitative assessment with strategic polarity mapping to identify actionable growth opportunities. The matrix below shows the overall relationship landscape, with each peer plotted by trust and skills/alignment.`;
  const summaryLines = doc.splitTextToSize(summaryText, pageWidth - 120);
  doc.text(summaryLines, 60, y);
  y += summaryLines.length * 15 + 10;

  // Matrix chart as image
  const matrixCanvas = document.getElementById('matrixChart-all');
  if (matrixCanvas && matrixCanvas.offsetParent !== null) {
    // Wait a bit to ensure chart is rendered
    setTimeout(() => {
      html2canvas(matrixCanvas, { backgroundColor: null }).then(canvas => {
        const matrixImg = canvas.toDataURL('image/png');
        try {
          doc.addImage(matrixImg, 'PNG', 60, y, pageWidth - 120, (pageWidth - 120) * 0.7);
          y += (pageWidth - 120) * 0.7 + 20;
        } catch (e) {
          // If PNG is corrupt, skip image
        }
        addQuadrantMeanings(doc, y, pageWidth);
        addPersonPagesTextIcons(doc, pageWidth);
        doc.save('partnership-assessment-text-icons.pdf');
      }).catch(() => {
        // If html2canvas fails, just skip the image
        addQuadrantMeanings(doc, y, pageWidth);
        addPersonPagesTextIcons(doc, pageWidth);
        doc.save('partnership-assessment-text-icons.pdf');
      });
    }, 300); // 300ms delay
  } else {
    addQuadrantMeanings(doc, y, pageWidth);
    addPersonPagesTextIcons(doc, pageWidth);
    doc.save('partnership-assessment-text-icons.pdf');
  }
}

function addPersonPagesTextIcons(doc, pageWidth) {
  const relRows = [
    { label: 'Mutual Trust', key: 'trust' },
    { label: 'Reliable Backup', key: 'reliable_backup' },
    { label: 'Open Communication', key: 'communication' },
    { label: 'Shared Goals', key: 'goals' },
    { label: 'Collaboration', key: 'collaboration' },
    { label: 'Strategic Planning', key: 'strategic_planning' }
  ];
  people.forEach((name, idx) => {
    doc.addPage();
    let py = 60;
    doc.setFontSize(18);
    doc.setFont('helvetica', 'bold');
    doc.text(name, 60, py);
    py += 24;
    doc.setFontSize(13);
    doc.setFont('helvetica', 'bold');
    doc.text('Relationship Matrix', 60, py);
    py += 18;
    doc.setFont('helvetica', 'normal');
    const rel = (assessmentData[idx] || {}).relationship || {};
    relRows.forEach(row => {
      doc.text(`${row.label}: ${rel[row.key] || '-'}/5`, 80, py);
      py += 15;
    });
    py += 12;
    // Work Style
    doc.setFont('helvetica', 'bold');
    doc.text('Work Style Preferences', 60, py);
    py += 18;
    doc.setFont('helvetica', 'normal');
    const pol = (assessmentData[idx] || {}).polarity || {};
    const polRows = [
      { label: 'Decision Making', key: 'decision', map: { analytical: 'Analytical', intuitive: 'Intuitive' }, icon: 'ðŸ§ ', explain: {
        analytical: {
          desc: 'Analytical decision makers rely on data, logic, and careful analysis. They are thorough, objective, and minimize risk by considering all options. They may take longer to decide, but their choices are well-founded.',
          strengths: 'Thorough, objective, minimizes risk.',
          growth: 'May overanalyze or delay decisions.'
        },
        intuitive: {
          desc: 'Intuitive decision makers trust their instincts and experience. They are comfortable making quick judgments, even with incomplete information, and often spot patterns others miss. This can lead to creative solutions and rapid progress.',
          strengths: 'Fast, creative, adapts quickly.',
          growth: 'May overlook details or act impulsively.'
        }
      } },
      { label: 'Communication', key: 'communication', map: { direct: 'Direct', diplomatic: 'Diplomatic' }, icon: 'ðŸ—£ï¸', explain: {
        direct: {
          desc: 'Direct communicators are clear and to the point. They are efficient, avoids misunderstandings.',
          strengths: 'Efficient, avoids misunderstandings.',
          growth: 'Can be perceived as blunt.'
        },
        diplomatic: {
          desc: 'Diplomatic communicators are tactful and relationship-focused. They build rapport, resolves conflict.',
          strengths: 'Builds rapport, resolves conflict.',
          growth: 'May avoid tough conversations.'
        }
      } },
      { label: 'Work Pace', key: 'pace', map: { fast: 'Fast', deliberate: 'Deliberate' }, icon: 'âš¡', explain: {
        fast: {
          desc: 'Fast workers move quickly and get results. They are responsive, meets deadlines.',
          strengths: 'Responsive, meets deadlines.',
          growth: 'May miss details.'
        },
        deliberate: {
          desc: 'Deliberate workers are thorough and methodical. They are high quality, reliable.',
          strengths: 'High quality, reliable.',
          growth: 'May be slow to act.'
        }
      } },
      { label: 'Risk Approach', key: 'risk', map: { high: 'Embraces Innovation', low: 'Prefers Proven Methods' }, icon: 'ðŸŽ²', explain: {
        high: {
          desc: 'Embraces innovation and is comfortable with uncertainty. They drive change, finds new solutions.',
          strengths: 'Drives change, finds new solutions.',
          growth: 'May take unnecessary risks.'
        },
        low: {
          desc: 'Prefers proven methods and established processes. They are stable, minimizes mistakes.',
          strengths: 'Stable, minimizes mistakes.',
          growth: 'May resist change.'
        }
      } }
    ];
    polRows.forEach(row => {
      const val = pol[row.key];
      if (!val) return;
      doc.text(`${row.icon} ${row.label}: ${row.map[val]}`, 80, py);
      py += 13;
      doc.setFontSize(10);
      const explLines = doc.splitTextToSize(row.explain[val], pageWidth - 120);
      doc.text(explLines, 100, py);
      doc.setFontSize(13);
      py += explLines.length * 13 + 8;
    });
    // Interaction Style
    py += 4;
    doc.setFont('helvetica', 'bold');
    doc.text('Dominant Interaction Style', 60, py);
    py += 18;
    doc.setFont('helvetica', 'normal');
    const style = (assessmentData[idx] || {}).socialStyle || '';
    const styleMap = {
      analytical: 'Analytical: Methodical, detail-oriented, values accuracy. Prefers to gather all relevant information before making decisions.',
      driving: 'Driving: Decisive, results-focused, and thrives on achievement. Quick to make decisions and set ambitious goals.',
      amiable: 'Amiable: Supportive, cooperative, and values relationships. Works to create harmony and is sensitive to the needs of others.',
      expressive: 'Expressive: Enthusiastic, creative, and persuasive. Energizes teams with ideas and optimism.'
    };
    const styleLines = doc.splitTextToSize(styleMap[style] || '-', pageWidth - 120);
    doc.text(styleLines, 80, py);
    py += styleLines.length * 13 + 8;
    // Action Items
    doc.setFont('helvetica', 'bold');
    doc.text('Action Items', 60, py);
    py += 16;
    doc.setFont('helvetica', 'normal');
    const actions = [];
    if ((rel.trust || 0) < 3) actions.push('Schedule a 1:1 coffee chat or informal meeting to build mutual trust. Share a recent success and ask about theirs.');
    if ((rel.reliable_backup || 0) < 3) actions.push('Clarify roles and responsibilities in your next project. For example, write down who owns which deliverable and review together.');
    if ((rel.communication || 0) < 3) actions.push('Set up a recurring 15-minute sync to discuss deal strategy and encourage open feedback. Try using a shared doc for agenda and notes.');
    if ((rel.goals || 0) < 3) actions.push('At your next team meeting, align on a shared goal and write it down. Ask each person to describe what success looks like.');
    if ((rel.collaboration || 0) < 3) actions.push('Invite your peer to co-lead a client call or demo. Debrief afterwards to discuss what went well and what could improve.');
    if ((rel.strategic_planning || 0) < 3) actions.push('Plan your next joint activity together, such as a customer workshop. Outline the agenda collaboratively in advance.');
    if (actions.length === 0) actions.push('Keep up the great partnership! Consider celebrating your success with a team lunch or shoutout.');
    actions.forEach(a => {
      doc.setFontSize(11);
      const actionLines = doc.splitTextToSize(`- ${a}`, pageWidth - 120);
      doc.text(actionLines, 80, py);
      py += actionLines.length * 12 + 4;
    });
  });
}

function addQuadrantMeanings(doc, y, pageWidth) {
  doc.setFontSize(14);
  doc.setFont('helvetica', 'bold');
  doc.text('Quadrant Meanings', 60, y);
  y += 18;
  doc.setFontSize(11);
  doc.setFont('helvetica', 'normal');
  const quadrantLines = [
    ['Anarchy', 'High skills/alignment, low trust. Great potential, but trust must be built for success.'],
    ['Synergy', 'High trust and high skills/alignment. Ideal partnership for high performance.'],
    ['Apathy', 'Low trust and low skills/alignment. Partnership needs significant attention.'],
    ['Energy', 'High trust, low skills/alignment. Good relationship, but need to align on goals and skills.']
  ];
  const quadrantColors = ['#e6007e', '#22c55e', '#bbb', '#f59e42'];
  quadrantLines.forEach(([label, desc], i) => {
    doc.setTextColor(quadrantColors[i]);
    doc.setFont('helvetica', 'bold');
    doc.text(label, 70, y);
    doc.setTextColor('#444');
    doc.setFont('helvetica', 'normal');
    doc.text(desc, 130, y);
    y += 18;
  });
}

</script>

<!-- Move this to after the script tag, at the very end of the body -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  // --- Text Icons Version ---
  const exampleBtnText = document.getElementById('download-example-pdf-btn-text');
  if (exampleBtnText) {
    exampleBtnText.onclick = function() {
      people = ['Alice Example', 'Bob Sample'];
      assessmentData = [
        {
          relationship: {
            trust: 5, reliable_backup: 4, communication: 5, goals: 4, collaboration: 5, strategic_planning: 4
          },
          polarity: {
            decision: 'analytical', communication: 'direct', pace: 'fast', risk: 'high'
          },
          socialStyle: 'driving'
        },
        {
          relationship: {
            trust: 2, reliable_backup: 2, communication: 3, goals: 2, collaboration: 3, strategic_planning: 2
          },
          polarity: {
            decision: 'intuitive', communication: 'diplomatic', pace: 'deliberate', risk: 'low'
          },
          socialStyle: 'amiable'
        }
      ];
      renderResultsPage();
      setTimeout(() => generatePdfTextIcons(), 500);
    };
  }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // --- Print-Friendly PDF Button ---
  const printBtn = document.getElementById('print-friendly-btn');
  if (printBtn) {
    printBtn.onclick = function() {
      document.body.classList.add('print-mode');
      setTimeout(() => {
        window.print();
        setTimeout(() => {
          document.body.classList.remove('print-mode');
        }, 500);
      }, 100);
    };
  }
});
</script>
</body>
</html>
